name: CI

on:
  push:
    branches:
      - master
    tags:
      - v*
  pull_request:

jobs:

  build:
    runs-on: ${{ matrix.os }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: [2.7, 3.4, 3.5, 3.6, 3.7, 3.8]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        id: python-dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[testing]
          python -m pip install flake8 pytest-xdist coveralls
      - name: Lint with flake8
        id: flake8
        run: |
          flake8 . --count --statistics
      - name: Test with pytest
        id: tests
        run: |
          COVERAGE_FILE=".coverage.${{ matrix.python-version }}" python -m pytest -n auto --cov=cr.cube
      - name: Coveralls
        run: coveralls
        env:
          COVERALLS_FLAG_NAME: "test-${{ matrix.python-version }}"
          COVERALLS_PARALLEL: true
  coveralls:
    needs: build
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: 3.7
      - name: Upload coverage
        run: |
          pip install coveralls
          coveralls --finish


#  coveralls_finish:
#    needs: build
#    runs-on: ubuntu-latest
#    env:
#      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
#    steps:
#      - name: Coveralls Finished
#        uses: AndreMiras/coveralls-python-action@develop
#        with:
#          parallel-finished: true
#  coveralls:
#    name: Coveralls
#    needs: build
#    runs-on: ubuntu-latest
#    container: python:3.6-slim
#    steps:
#    - name: Finished
#      run: |
#        pip3 install --upgrade coveralls
#        coveralls --finish
#      with:
#        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
#      - name: Archive code coverage results
#        uses: actions/upload-artifact@v2
#        with:
#          name: code-coverage-report
#          path: .coverage.${{ matrix.python-version }}

#  coveralls:
#    needs: build
#    runs-on: ubuntu-latest
#    env:
#      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
#    steps:
#      - uses: actions/checkout@v2
#      - name: Set up Python 3.6
#        uses: actions/setup-python@v2
#        with:
#          python-version: 3.6
#      - name: Install python dependencies
#        run: |
#          python -m pip install --upgrade pip
#          python -m pip install -e .[testing]
#          python -m pip install coveralls
#      - name: Download coverage reports
#        uses: actions/download-artifact@v2
#        with:
#          name: code-coverage-report
#      - name: Upload results on coveralls
#        run: |
#          python -m coverage combine
#          python -m coverage report
#          python -m coveralls
